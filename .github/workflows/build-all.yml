name: XMRig-MD Build Artifacts (all)

on:
  workflow_dispatch:

jobs:
  # ----------------------------------------------------------------------
  # WINDOWS BUILD (MinGW via MSYS2)
  # ----------------------------------------------------------------------
  build_win:
    name: Build Windows (x64)
    runs-on: windows-2022
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Checkout dependencies
        run: git clone https://github.com/xmrig/xmrig-deps.git xmrig-deps

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-make
            mingw-w64-x86_64-tools
            git
          update: true

      - name: Build XMRig
        shell: msys2 {0}
        run: |
          mkdir build
          cd build
          cmake .. -G "MinGW Makefiles" -DXMRIG_DEPS=../xmrig-deps/gcc/x64 -DWITH_CN_GPU=OFF -DBUILD_STATIC=ON
          mingw32-make -j2

      - name: Package Windows
        shell: msys2 {0}
        run: |
          cp src/config.json build/config.json
          # WinRing0 might not exist in source if not explicitly added, checking first
          if [ -f "src/WinRing0/WinRing0x64.sys" ]; then
            cp src/WinRing0/WinRing0x64.sys build/WinRing0x64.sys
          fi
          cd build
          7z a -tzip -mx windows_build.zip xmrig.exe config.json *.sys

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows_build
          path: build/windows_build.zip

  # ----------------------------------------------------------------------
  # LINUX STATIC BUILD (CentOS 7 via Vault)
  # ----------------------------------------------------------------------
  build_linux_static:
    name: Build Linux Static (CentOS 7)
    runs-on: ubuntu-latest
    container: centos:7
    steps:
      - name: Fix CentOS 7 Repos (Point to Vault)
        run: |
          # Rewrite mirrors to vault.centos.org and use HTTP to avoid expired SSL root cert issues
          sed -i 's/mirrorlist/#mirrorlist/g' /etc/yum.repos.d/CentOS-*
          sed -i 's|#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g' /etc/yum.repos.d/CentOS-*
          # Clean metadata
          yum clean all

      - name: Install Toolchain
        run: |
          yum install -y centos-release-scl epel-release
          # Fix EPEL if needed (sometimes EPEL mirrors fail on EOL too, but usually SCL works)
          yum install -y devtoolset-9 cmake3 git make automake libtool autoconf libstdc++-static glibc-static which

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Dependencies (Script)
        run: |
          source /opt/rh/devtoolset-9/enable
          mkdir -p build
          cd scripts
          ./build_deps.sh

      - name: Build XMRig
        run: |
          source /opt/rh/devtoolset-9/enable
          cd build
          cmake3 .. -DXMRIG_DEPS=../scripts/deps -DBUILD_STATIC=ON
          make -j$(nproc)

      - name: Package Linux
        run: |
          cd build
          cp ../src/config.json .
          tar -czvf linux_static_build.tar.gz xmrig config.json

      - name: Upload Linux Artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux_static_build
          path: build/linux_static_build.tar.gz

  # ----------------------------------------------------------------------
  # MACOS ARM64 (Apple Silicon / M1+)
  # ----------------------------------------------------------------------
  build_macos_arm64:
    name: Build macOS (Apple Silicon)
    runs-on: macos-14
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          # brew install returns 1 if already installed, so we allow it to 'fail' cleanly
          brew install cmake libuv openssl@3 hwloc || true

      - name: Build
        run: |
          mkdir build
          cd build
          # Dynamically find OpenSSL location for Homebrew
          cmake .. -DOPENSSL_ROOT_DIR=$(brew --prefix openssl@3)
          make -j$(sysctl -n hw.logicalcpu)

      - name: Package macOS ARM
        run: |
          cd build
          cp ../src/config.json .
          tar -czvf macos_arm64_build.tar.gz xmrig config.json

      - name: Upload macOS ARM Artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos_arm64_build
          path: build/macos_arm64_build.tar.gz

  # ----------------------------------------------------------------------
  # MACOS INTEL (x64) - Legacy
  # ----------------------------------------------------------------------
  build_macos_intel:
    name: Build macOS (Intel)
    runs-on: macos-12
    # macos-12 is the fallback for Intel. macos-13 is phasing out/region locked.
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          brew install cmake libuv openssl@3 hwloc || true

      - name: Build
        run: |
          mkdir build
          cd build
          # Intel Mac usually puts brew in /usr/local, but using --prefix is safer
          cmake .. -DOPENSSL_ROOT_DIR=$(brew --prefix openssl@3)
          make -j$(sysctl -n hw.logicalcpu)

      - name: Package macOS Intel
        run: |
          cd build
          cp ../src/config.json .
          tar -czvf macos_intel_build.tar.gz xmrig config.json

      - name: Upload macOS Intel Artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos_intel_build
          path: build/macos_intel_build.tar.gz
