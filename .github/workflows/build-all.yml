name: XMRig-MD Build Artifacts (all)

on:
  workflow_dispatch:

jobs:
  # ----------------------------------------------------------------------
  # WINDOWS BUILD (MinGW via MSYS2 Package Manager)
  # ----------------------------------------------------------------------
  build_win:
    name: Build Windows (x64)
    runs-on: windows-2022
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          # We install dependencies directly via pacman instead of cloning xmrig-deps
          # This prevents "Could NOT find HWLOC" errors
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-make
            mingw-w64-x86_64-tools
            mingw-w64-x86_64-hwloc
            mingw-w64-x86_64-libuv
            mingw-w64-x86_64-openssl
            git
          update: true

      - name: Build XMRig
        shell: msys2 {0}
        run: |
          mkdir build
          cd build
          # Removed -DXMRIG_DEPS because we are using system (MSYS2) libs now
          cmake .. -G "MinGW Makefiles" -DWITH_CN_GPU=OFF -DBUILD_STATIC=ON
          mingw32-make -j2

      - name: Package Windows
        shell: msys2 {0}
        run: |
          cp src/config.json build/config.json
          # Check for WinRing0 driver presence
          if [ -f "src/WinRing0/WinRing0x64.sys" ]; then
            cp src/WinRing0/WinRing0x64.sys build/WinRing0x64.sys
          fi
          cd build
          7z a -tzip -mx windows_build.zip xmrig.exe config.json *.sys

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows_build
          path: build/windows_build.zip

  # ----------------------------------------------------------------------
  # LINUX STATIC BUILD (CentOS 7 via Vault)
  # ----------------------------------------------------------------------
  build_linux_static:
    name: Build Linux Static (CentOS 7)
    runs-on: ubuntu-latest
    container: centos:7
    steps:
      - name: Fix Base Repos (Vault)
        run: |
          # 1. Point Base repos to Vault
          sed -i 's/mirrorlist/#mirrorlist/g' /etc/yum.repos.d/CentOS-*
          sed -i 's|#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g' /etc/yum.repos.d/CentOS-*
          yum clean all

      - name: Install SCL Repo
        run: |
          # 2. Install SCL release package (creates new broken repo files)
          yum install -y centos-release-scl epel-release

      - name: Fix SCL Repos (Vault)
        run: |
          # 3. IMMEDIATELY Fix the new SCL repo files before using them
          sed -i 's/mirrorlist/#mirrorlist/g' /etc/yum.repos.d/CentOS-SCLo*
          sed -i 's|#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g' /etc/yum.repos.d/CentOS-SCLo*
          yum clean all

      - name: Install Toolchain
        run: |
          # 4. Now we can safely install the compiler
          yum install -y devtoolset-9 cmake3 git make automake libtool autoconf libstdc++-static glibc-static which

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Dependencies (Script)
        run: |
          source /opt/rh/devtoolset-9/enable
          mkdir -p build
          cd scripts
          ./build_deps.sh

      - name: Build XMRig
        run: |
          source /opt/rh/devtoolset-9/enable
          cd build
          cmake3 .. -DXMRIG_DEPS=../scripts/deps -DBUILD_STATIC=ON
          make -j$(nproc)

      - name: Package Linux
        run: |
          cd build
          cp ../src/config.json .
          tar -czvf linux_static_build.tar.gz xmrig config.json

      - name: Upload Linux Artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux_static_build
          path: build/linux_static_build.tar.gz

  # ----------------------------------------------------------------------
  # MACOS ARM64 (Apple Silicon)
  # ----------------------------------------------------------------------
  build_macos_arm64:
    name: Build macOS (Apple Silicon)
    runs-on: macos-14
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          brew install cmake libuv openssl@3 hwloc || true

      - name: Build
        run: |
          mkdir build
          cd build
          cmake .. -DOPENSSL_ROOT_DIR=$(brew --prefix openssl@3)
          make -j$(sysctl -n hw.logicalcpu)

      - name: Package macOS ARM
        run: |
          cd build
          cp ../src/config.json .
          tar -czvf macos_arm64_build.tar.gz xmrig config.json

      - name: Upload macOS ARM Artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos_arm64_build
          path: build/macos_arm64_build.tar.gz

  # ----------------------------------------------------------------------
  # MACOS INTEL (x64)
  # ----------------------------------------------------------------------
  build_macos_intel:
    name: Build macOS (Intel)
    runs-on: macos-13
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          brew install cmake libuv openssl@3 hwloc || true

      - name: Build
        run: |
          mkdir build
          cd build
          cmake .. -DOPENSSL_ROOT_DIR=$(brew --prefix openssl@3)
          make -j$(sysctl -n hw.logicalcpu)

      - name: Package macOS Intel
        run: |
          cd build
          cp ../src/config.json .
          tar -czvf macos_intel_build.tar.gz xmrig config.json

      - name: Upload macOS Intel Artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos_intel_build
          path: build/macos_intel_build.tar.gz
