name: XMRig-MD Build Artifacts (all)

on:
  workflow_dispatch:

jobs:
  # ----------------------------------------------------------------------
  # WINDOWS BUILD (MSVC/MinGW)
  # ----------------------------------------------------------------------
  build_win:
    name: Build Windows (x64)
    runs-on: windows-2022
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Checkout dependencies
        run: git clone https://github.com/xmrig/xmrig-deps.git xmrig-deps

      - name: Build
        run: |
          mkdir build
          cd build
          cmake .. -G "MinGW Makefiles" -DXMRIG_DEPS=../xmrig-deps/gcc/x64 -DWITH_CN_GPU=OFF
          mingw32-make -j2

      - name: Package
        run: |
          copy src\config.json build\config.json
          copy src\WinRing0\WinRing0x64.sys build\WinRing0x64.sys
          cd build
          7z a -tzip -mx windows_build.zip xmrig.exe config.json WinRing0x64.sys

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows_build
          path: build/windows_build.zip

  # ----------------------------------------------------------------------
  # LINUX STATIC BUILD (CentOS 7 for max compatibility)
  # ----------------------------------------------------------------------
  build_linux_static:
    name: Build Linux Static (CentOS 7)
    runs-on: ubuntu-latest
    container: centos:7
    steps:
      - name: Fix CentOS 7 EOL Repositories
        run: |
          sed -i 's/mirrorlist/#mirrorlist/g' /etc/yum.repos.d/CentOS-*
          sed -i 's|#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g' /etc/yum.repos.d/CentOS-*

      - name: Install Toolchain
        run: |
          yum install -y centos-release-scl epel-release
          yum install -y devtoolset-9 cmake3 git make automake libtool autoconf libstdc++-static glibc-static which

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Dependencies (Script)
        run: |
          source /opt/rh/devtoolset-9/enable
          mkdir -p build
          cd scripts
          ./build_deps.sh

      - name: Build XMRig
        run: |
          source /opt/rh/devtoolset-9/enable
          cd build
          cmake3 .. -DXMRIG_DEPS=../scripts/deps -DBUILD_STATIC=ON
          make -j$(nproc)

      - name: Package
        run: |
          cd build
          cp ../src/config.json .
          tar -czvf linux_static_build.tar.gz xmrig config.json

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux_static_build
          path: build/linux_static_build.tar.gz

  # ----------------------------------------------------------------------
  # MACOS ARM64 (Apple Silicon / M1 / M2 / M3)
  # ----------------------------------------------------------------------
  build_macos_arm64:
    name: Build macOS (Apple Silicon)
    runs-on: macos-14
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: brew install cmake libuv openssl@3 hwloc

      - name: Build
        run: |
          mkdir build
          cd build
          cmake .. -DOPENSSL_ROOT_DIR=$(brew --prefix openssl@3)
          make -j$(sysctl -n hw.logicalcpu)

      - name: Package
        run: |
          cd build
          cp ../src/config.json .
          tar -czvf macos_arm64_build.tar.gz xmrig config.json

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos_arm64_build
          path: build/macos_arm64_build.tar.gz

  # ----------------------------------------------------------------------
  # MACOS INTEL (x64)
  # ----------------------------------------------------------------------
  build_macos_intel:
    name: Build macOS (Intel)
    runs-on: macos-13
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: brew install cmake libuv openssl@3 hwloc

      - name: Build
        run: |
          mkdir build
          cd build
          cmake .. -DOPENSSL_ROOT_DIR=$(brew --prefix openssl@3)
          make -j$(sysctl -n hw.logicalcpu)

      - name: Package
        run: |
          cd build
          cp ../src/config.json .
          tar -czvf macos_intel_build.tar.gz xmrig config.json

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos_intel_build
          path: build/macos_intel_build.tar.gz
